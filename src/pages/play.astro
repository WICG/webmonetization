---
import { getLangFromUrl, useTranslations } from '../i18n/utils'
import Base from '../layouts/Base.astro'
import ToolsHeader from '../components/pages/ToolsHeader.astro'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
---

<Base
  title={t('pages.play.title')}
  description={t('pages.play.description')}
  toolsStyling={true}
>
  <section class='section'>
    <div class='contentWrapper'>
      <ToolsHeader
        headingText='Web Monetization Playground'
        pageTitle='Playground'
        backButtonText='Go back'
      />
      <p class='text'>
        The Web Monetization Playground is an interactive environment that shows
        how Web Monetization works under the hood. Add a wallet address or
        payment pointer and watch events and payment flows unfold in real time.
      </p>
      <div class='form-wrapper'>
        <form id='walletAddressForm'>
          <div class='form-field'>
            <label for='walletAddressUrl'>Wallet address/Payment pointer</label>
            <input
              type='text'
              id='walletAddressUrl'
              name='walletAddressUrl'
              placeholder='https://walletprovider.com/myWallet'
              required
            />
          </div>
          <button
            class='btn tools-primary-btn'
            type='submit'
            disabled
          >
            Add monetization link
          </button>
          <p id='notice'>
            Checking if your browser supports Web Monetization...
          </p>
        </form>
      </div>
    </div>
    <div class='contentWrapper'>
      <div id='link-events' class='link-events'></div>
    </div>
  </section>
</Base>

<style>
  p.text {
    padding-inline: var(--padding-md);
    margin-bottom: var(--spacing-3xl);
  }
  .link-events {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(30rem, 1fr));
    width: 100%;
    padding-inline: var(--padding-md);
    margin-top: var(--spacing-md);
    gap: var(--spacing-md);
    font: var(--font-small-regular);
    div[data-wallet-address] {
      padding: var(--padding-md);
      background-color: var(--color-mint-50);
      border-radius: var(--moderate-rounding);
      border: 1px solid var(--color-green-100);
      & .log-header {
        padding-bottom: var(--padding-sm);
        margin-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--color-silver-200);
        gap: var(--spacing-sm);
        display: flex;
        align-items: center;
        justify-content: space-between;
        & p {
          max-width: 100%;
          overflow-x: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          text-align: center;
          color: var(--paragraph-success);
        }

        .wallet-switch {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);

          .switch-text {
            font: var(--font-standard-regular);
            color: var(--default-font-color);
          }

          .switch-container {
            position: relative;
            display: inline-block;
            width: 2.75rem;
            height: 1.5rem;
          }

          input {
            width: 100%;
            height: 100%;
          }

          .switch-slider {
            position: absolute;
            inset: 0;
            background-color: var(--color-silver-300);
            border-radius: var(--fully-rounded);
            cursor: pointer;
          }

          .switch-slider::before {
            content: '';
            position: absolute;
            width: 1.25rem;
            height: 1.25rem;
            top: 0.125rem;
            left: 0.125rem;
            background-color: var(--color-white);
            border-radius: var(--fully-rounded);
            transition: transform 0.3s;
          }

          input:checked + .switch-slider {
            background-color: var(--button-ghost-color);
          }

          input:checked + .switch-slider::before {
            transform: translateX(1.25rem);
          }
        }
      }

      & ul.events {
        font-family: var(--sl-font-system-mono);
        height: 20rem;
        margin-block: var(--spacing-sm);
        padding: var(--padding-sm) 0px var(--padding-sm) var(--padding-sm);
        list-style: none;
        overflow-y: auto;
        white-space: nowrap;
        border-bottom: 1px solid var(--color-silver-200);

        & li {
          margin-block-end: var(--spacing-2xs);

          & details {
            & summary {
              cursor: pointer;

              & span {
                text-decoration: underline dotted;
                text-underline-offset: 2px;
              }
            }

            & pre {
              padding: var(--padding-xs);
              margin-inline-start: var(--spacing-md);
            }
          }
        }
      }

      & .log-footer {
        gap: var(--spacing-sm);
        display: flex;
        align-items: center;
        justify-content: right;

        & button.tools-secondary-btn {
          background-color: transparent;
          color: var(--button-ghost-color);
          border: none;
          font: var(--font-standard-regular);
        }
        & button.tools-secondary-btn:hover,
        & button.tools-secondary-btn:focus-visible {
          background-color: var(--surface-hover-color);
          color: var(--button-hover-color);
        }
      }
    }
  }

  @media screen and (max-width: 767px) {
    p.text {
      margin-bottom: var(--spacing-lg);
    }
    .link-events {
      grid-template-columns: minmax(16.5rem, 1fr);
      div[data-wallet-address] {
        & .log-header {
          flex-wrap: wrap;
        }
      }
    }
  }
</style>

<script>
  import cleanIcon from '@assets/clean-icon.svg?raw'
  import removeIcon from '@assets/remove-icon.svg?raw'
  const form = document.querySelector('#walletAddressForm') as HTMLFormElement
  const notice = document.querySelector('#notice') as HTMLParagraphElement
  const input = form.querySelector('input') as HTMLInputElement
  const submitButton = form.querySelector('button') as HTMLButtonElement
  const linkEvents = document.querySelector('#link-events') as HTMLDivElement

  if (window.MonetizationEvent) {
    submitButton.disabled = false
    notice.style.display = 'none'
    addTagsFromURL()
  } else {
    setTimeout(() => {
      if (!window.MonetizationEvent) {
        notice.textContent = 'Your browser does not support Web Monetization.'
        notice.style.display = 'block'
        notice.classList.add('error')
        submitButton.disabled = true
      } else {
        submitButton.disabled = false
        notice.style.display = 'none'
        addTagsFromURL()
      }
    }, 500)
  }

  function createLinkTag(href: string) {
    const link = document.createElement('link')

    link.rel = 'monetization'
    link.href = href
    link.addEventListener('monetization', onMonetizationListener)
    link.addEventListener('load', onLoadListener)
    link.addEventListener('error', onErrorListener)
    link.dataset.walletAddress = href

    document.head.append(link)
  }

  async function createLinkEventLog(href: string) {
    const header = document.createElement('div')
    header.classList.add('log-header')

    const title = document.createElement('p')
    title.textContent = href

    const footer = document.createElement('div')
    footer.classList.add('log-footer')

    const switchButton = document.createElement('label')
    switchButton.classList.add('wallet-switch')
    switchButton.innerHTML = `
      <span class="switch-text">Enabled</span>
      <span class="switch-container">
        <input type="checkbox" checked>
        <span class="switch-slider"></span>
      </span>`

    switchButton.addEventListener('click', () => {
      const link = document.querySelector(
        `link[rel='monetization'][href='${href}']`
      ) as HTMLLinkElement
      link.disabled = !link.disabled
    })

    const removeButton = document.createElement('button')
    removeButton.innerHTML = `${removeIcon}Remove`
    removeButton.classList.add('btn', 'tools-secondary-btn')
    removeButton.addEventListener('click', () => {
      const link = document.querySelector(
        `link[rel='monetization'][href='${href}']`
      ) as HTMLLinkElement
      link.remove()
      const eventLog = document.querySelector(
        `#link-events div[data-wallet-address='${href}']`
      ) as HTMLDivElement
      eventLog.remove()
    })

    const clearButton = document.createElement('button')
    clearButton.innerHTML = `${cleanIcon}Clean`
    clearButton.classList.add('btn', 'tools-secondary-btn')
    clearButton.addEventListener('click', () => {
      const ul = document.querySelector(
        `#link-events div[data-wallet-address='${href}'] ul.events`
      ) as HTMLDivElement
      ul.innerHTML = ''
    })

    header.append(title)
    header.append(switchButton)

    footer.append(clearButton)
    footer.append(removeButton)

    const eventLog = document.createElement('div')
    eventLog.dataset.walletAddress = href

    const events = document.createElement('ul')
    events.classList.add('events')

    eventLog.append(header)
    eventLog.append(events)
    eventLog.append(footer)

    linkEvents.append(eventLog)
  }

  function getLinkEventLog(event: Event): HTMLDivElement | null {
    if (!(event.target instanceof HTMLLinkElement)) return null
    if (!event.target.isConnected) return null

    return document.querySelector(
      `#link-events div[data-wallet-address='${event.target.dataset.walletAddress}'] ul.events`
    ) as HTMLDivElement
  }

  function capitalize(str: string) {
    return str.charAt(0).toUpperCase() + str.slice(1)
  }

  function createLog(
    div: HTMLDivElement,
    type: string,
    event?: MonetizationEvent
  ) {
    const log = document.createElement('li')

    const time = new Date().toLocaleTimeString()
    let slot = `${capitalize(type)} Event`

    if (event) {
      const details = document.createElement('details')
      const summary = document.createElement('summary')
      const span = document.createElement('span')
      span.textContent = `${slot} - ${event.amountSent.value} ${event.amountSent.currency}`
      summary.append(`[${time}] `)
      summary.append(span)
      details.append(summary)

      const pre = document.createElement('pre')
      pre.textContent = JSON.stringify(event, null, 2)
      details.append(pre)

      log.append(details)
    } else {
      if (type === 'error') {
        slot += ` (Check browser console)`
      }

      const spacer = document.createElement('span')
      spacer.append(` [${time}] ${slot}`)
      log.append(spacer)
    }

    div.prepend(log)
  }

  function onMonetizationListener(event: MonetizationEvent) {
    const linkEventLog = getLinkEventLog(event)
    if (!linkEventLog) return

    if (linkEventLog.dataset.incomingPayment !== event.incomingPayment) {
      linkEventLog.dataset.incomingPayment = event.incomingPayment
    }

    createLog(linkEventLog, event.type, event)
  }

  function onLoadListener(event: Event) {
    const linkEventLog = getLinkEventLog(event)
    if (!linkEventLog) return

    createLog(linkEventLog, event.type)
  }

  function onErrorListener(event: Event) {
    const linkEventLog = getLinkEventLog(event)
    if (!linkEventLog) return

    createLog(linkEventLog, event.type)
  }

  function toWalletAddressUrl(s: string): string {
    return s.startsWith('$') ? s.replace('$', 'https://') : s
  }

  input.addEventListener('input', function () {
    this.setCustomValidity('')
  })

  form.addEventListener('submit', async (e) => {
    e.preventDefault()

    const formData = new FormData(form)
    const walletAddress = formData.get('walletAddressUrl')?.valueOf()

    if (!walletAddress || typeof walletAddress !== 'string') {
      input.setCustomValidity('Please fill the wallet address URL field.')
      return false
    }

    const walletAddressUrl = toWalletAddressUrl(walletAddress)

    if (addressAlreadyAdded(walletAddressUrl)) {
      input.setCustomValidity(`${walletAddress} already exists in the page.`)
      input.reportValidity()
      return false
    }

    await createLinkEventLog(walletAddressUrl)
    createLinkTag(walletAddressUrl)

    form.reset()
  })

  async function addTagsFromURL() {
    const walletAddressUrls = new URLSearchParams(location.search).getAll('wa')
    const urlsToAdd = new Set(walletAddressUrls.filter(isWalletAddressUrl))
    for (const url of urlsToAdd) {
      await createLinkEventLog(url)
    }
    urlsToAdd.forEach(createLinkTag)
  }

  function isWalletAddressUrl(s: string): boolean {
    try {
      return !!new URL(s)
    } catch {
      return false
    }
  }

  function addressAlreadyAdded(walletAddressUrl: string) {
    // current implementation of playground doesn't support adding same link tag twice
    // BUG: it should be allowed
    return !!document.querySelector(
      `[data-wallet-address='${walletAddressUrl}']`
    )
  }
</script>
